<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=no, viewport-fit=cover" />
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Simple AR Photo</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html {
            height: 100%;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            overflow: hidden;
            background: #000;
            position: fixed;
            width: 100%;
            height: 100%;
            height: 100vh;
            height: 100dvh;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ */
        html, body {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-scrollbar: none;
        }

        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;
        }

        /* AR Scene - –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É */
        #ar-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            height: 100vh !important;
            height: 100dvh !important;
            z-index: 1 !important;
            overflow: hidden !important;
        }
        
        /* –°—Ç–∞—Ç—É—Å */
        .status {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            top: max(env(safe-area-inset-top), 20px);
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            text-align: center;
            max-width: calc(100vw - 40px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform: translateZ(0);
            will-change: transform;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ */
        .photo-button {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 30px);
            bottom: max(env(safe-area-inset-bottom, 30px), 30px);
            left: 50%;
            transform: translateX(-50%) translateZ(0);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #fff;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            will-change: transform;
            touch-action: manipulation;
        }
        
        .photo-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(-50%) scale(1.05) translateZ(0);
        }
        
        .photo-button:active {
            transform: translateX(-50%) scale(0.95) translateZ(0);
            transition: all 0.1s ease;
        }
        
        /* –§–ª–µ—à —ç—Ñ—Ñ–µ–∫—Ç */
        .photo-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100vh;
            height: 100dvh;
            background: white;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease;
            transform: translateZ(0);
        }
        
        /* –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ */
        .photo-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateZ(0);
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 140px);
            max-height: calc(100dvh - 140px);
            border: 4px solid white;
            border-radius: 12px;
            z-index: 3000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            will-change: transform;
        }
        
        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø—Ä–µ–≤—å—é */
        .preview-controls {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 20px);
            bottom: max(env(safe-area-inset-bottom, 20px), 20px);
            left: 50%;
            transform: translateX(-50%) translateZ(0);
            z-index: 3000;
            display: none;
            gap: 15px;
            will-change: transform;
        }
        
        .preview-controls button {
            padding: 14px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            touch-action: manipulation;
            transform: translateZ(0);
            will-change: transform;
        }
        
        .save-btn {
            background: rgba(76, 175, 80, 0.95);
            color: white;
        }
        
        .close-btn {
            background: rgba(244, 67, 54, 0.95);
            color: white;
        }
        
        .save-btn:hover {
            background: rgba(69, 160, 73, 1);
            transform: scale(1.05) translateZ(0);
        }
        
        .close-btn:hover {
            background: rgba(218, 25, 11, 1);
            transform: scale(1.05) translateZ(0);
        }

        .save-btn:active,
        .close-btn:active {
            transform: scale(0.95) translateZ(0);
            transition: all 0.1s ease;
        }
        
        /* UI —ç–ª–µ–º–µ–Ω—Ç—ã */
        .ui-elements {
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 999;
        }
        
        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* –ú–µ–¥–∏–∞ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media screen and (max-width: 768px) {
            .status {
                font-size: 12px;
                padding: 10px 14px;
                top: env(safe-area-inset-top, 15px);
                top: max(env(safe-area-inset-top), 15px);
            }

            .photo-button {
                width: 70px;
                height: 70px;
                font-size: 24px;
                bottom: env(safe-area-inset-bottom, 25px);
                bottom: max(env(safe-area-inset-bottom, 25px), 25px);
            }

            .preview-controls button {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 80px;
            }

            .photo-preview {
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 120px);
                max-height: calc(100dvh - 120px);
                border-width: 2px;
            }
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Android */
        @media screen and (max-width: 480px) {
            .status {
                font-size: 11px;
                padding: 8px 12px;
            }

            .photo-button {
                width: 65px;
                height: 65px;
                font-size: 22px;
            }

            .preview-controls {
                bottom: env(safe-area-inset-bottom, 15px);
                bottom: max(env(safe-area-inset-bottom, 15px), 15px);
            }

            .preview-controls button {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 70px;
            }
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞ iOS */
        @supports (-webkit-appearance: none) {
            body {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="ui-elements">
        <div class="status" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR...</div>
        
        <button class="photo-button" onclick="takePhotoAlternative()">
            üì∑
        </button>
    </div>
    
    <div class="photo-flash" id="photoFlash"></div>
    
    <img class="photo-preview" id="photoPreview" />
    
    <div class="preview-controls" id="previewControls">
        <button class="save-btn" onclick="savePhoto()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="close-btn" onclick="closePreview()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- AR Scene - —Ç–µ–ø–µ—Ä—å –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ -->
    <a-scene id="ar-scene" 
             mindar-image="imageTargetSrc: ./assets/cheburashka.mind;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights, antialias: true" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             embedded>
             
      <!-- –ê—Å—Å–µ—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
      <a-assets>
        <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" />
        <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- –ú–∞—Ä–∫–µ—Ä—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª–∏ -->
    </a-scene>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ -->
    <script src="./markers/cheburashka.js"></script>

<script>
let currentPhotoData = null;
let activeMarkers = {}; // –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –∏ –∑—É–º–∞
document.addEventListener('touchmove', function(e) {
    e.preventDefault();
}, { passive: false });

document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
});

document.addEventListener('gesturechange', function(e) {
    e.preventDefault();
});

document.addEventListener('gestureend', function(e) {
    e.preventDefault();
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞ –¥–ª—è –∑—É–º–∞
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus(message) {
    document.getElementById('status').textContent = message;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞ —Å AR —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
async function takePhoto() {
    try {
        updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ AR —Ñ–æ—Ç–æ...');
        
        // –°–∫—Ä—ã–≤–∞–µ–º UI
        const uiElements = document.querySelector('.ui-elements');
        uiElements.classList.add('hidden');
        
        // –ñ–¥–µ–º —Å–∫—Ä—ã—Ç–∏—è UI
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø—ã—à–∫—É
        const flash = document.getElementById('photoFlash');
        flash.style.opacity = '0.7';
        
        const sceneEl = document.querySelector('#ar-scene');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä
        sceneEl.renderer.render(sceneEl.object3D, sceneEl.camera);
        
        // –ü–æ–ª—É—á–∞–µ–º canvas –æ—Ç Three.js renderer
        const webglCanvas = sceneEl.renderer.domElement;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã viewport (–≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å)
        const rect = sceneEl.getBoundingClientRect();
        const viewportWidth = rect.width;
        const viewportHeight = rect.height;
        
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π canvas —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ viewport
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = viewportWidth;
        finalCanvas.height = viewportHeight;
        const finalCtx = finalCanvas.getContext('2d');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
        finalCtx.imageSmoothingEnabled = false;
        
        // –ö–æ–ø–∏—Ä—É–µ–º WebGL canvas –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π canvas —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
        finalCtx.drawImage(
            webglCanvas, 
            0, 0, webglCanvas.width, webglCanvas.height,
            0, 0, viewportWidth, viewportHeight
        );
        
        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const dataURL = finalCanvas.toDataURL('image/png', 1.0);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –Ω–µ –ø—É—Å—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (dataURL === 'data:,' || dataURL.length < 1000) {
            throw new Error('–ü—É—Å—Ç–æ–π —Å–Ω–∏–º–æ–∫ WebGL canvas');
        }
        
        currentPhotoData = dataURL;
        
        // –£–±–∏—Ä–∞–µ–º –≤—Å–ø—ã—à–∫—É
        setTimeout(() => {
            flash.style.opacity = '0';
        }, 100);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
        const preview = document.getElementById('photoPreview');
        const controls = document.getElementById('previewControls');
        
        preview.src = dataURL;
        preview.style.display = 'block';
        controls.style.display = 'flex';
        
        updateStatus('AR —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ!');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è AR —Ñ–æ—Ç–æ:', error);
        updateStatus('–û—à–∏–±–∫–∞ AR —Ñ–æ—Ç–æ: ' + error.message);
        
        // –ü—Ä–æ–±—É–µ–º –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –∫–∞–∫ fallback
        try {
            await takeCompositePhoto();
        } catch (e) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            const uiElements = document.querySelector('.ui-elements');
            uiElements.classList.remove('hidden');
            
            const flash = document.getElementById('photoFlash');
            flash.style.opacity = '0';
        }
    }
}

// –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –º–µ—Ç–æ–¥ - —Å–º–µ—à–∏–≤–∞–µ–º –≤–∏–¥–µ–æ + AR —Ä–µ–Ω–¥–µ—Ä —Å —Ç–æ—á–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
async function takeCompositePhoto() {
    try {
        updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ —Ñ–æ—Ç–æ...');
        
        const sceneEl = document.querySelector('#ar-scene');
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã AR viewport
        const rect = sceneEl.getBoundingClientRect();
        const viewportWidth = Math.floor(rect.width);
        const viewportHeight = Math.floor(rect.height);
        
        console.log(`Viewport —Ä–∞–∑–º–µ—Ä—ã: ${viewportWidth}x${viewportHeight}`);
        
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π canvas –¢–û–ß–ù–û –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º viewport
        const compositeCanvas = document.createElement('canvas');
        compositeCanvas.width = viewportWidth;
        compositeCanvas.height = viewportHeight;
        const ctx = compositeCanvas.getContext('2d');
        
        // –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, viewportWidth, viewportHeight);
        
        // 1. –†–∏—Å—É–µ–º –≤–∏–¥–µ–æ —Ñ–æ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–∫–∞–∫ –≤ AR)
        const video = document.querySelector('video');
        if (video && video.videoWidth > 0) {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            console.log(`–í–∏–¥–µ–æ —Ä–∞–∑–º–µ—Ä—ã: ${videoWidth}x${videoHeight}`);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ CSS object-fit: cover
            const videoAspect = videoWidth / videoHeight;
            const viewportAspect = viewportWidth / viewportHeight;
            
            let sourceX = 0, sourceY = 0, sourceWidth = videoWidth, sourceHeight = videoHeight;
            
            if (videoAspect > viewportAspect) {
                // –í–∏–¥–µ–æ —à–∏—Ä–µ viewport - –æ–±—Ä–µ–∑–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ (–∫–∞–∫ –≤ AR)
                sourceWidth = videoHeight * viewportAspect;
                sourceX = (videoWidth - sourceWidth) / 2;
            } else {
                // –í–∏–¥–µ–æ –≤—ã—à–µ viewport - –æ–±—Ä–µ–∑–∞–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ (–∫–∞–∫ –≤ AR)
                sourceHeight = videoWidth / viewportAspect;
                sourceY = (videoHeight - sourceHeight) / 2;
            }
            
            console.log(`–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ: ${sourceX}, ${sourceY}, ${sourceWidth}, ${sourceHeight}`);
            
            // –†–∏—Å—É–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –≤–µ—Å—å canvas
            ctx.drawImage(
                video,
                sourceX, sourceY, sourceWidth, sourceHeight,  // source rect (–æ–±—Ä–µ–∑–∞–Ω–Ω–∞—è —á–∞—Å—Ç—å –≤–∏–¥–µ–æ)
                0, 0, viewportWidth, viewportHeight           // dest rect (–≤–µ—Å—å canvas)
            );
        }
        
        // 2. –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º AR —Ä–µ–Ω–¥–µ—Ä –¢–û–ß–ù–û –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º
        const webglCanvas = sceneEl.renderer.domElement;
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä
        sceneEl.renderer.render(sceneEl.object3D, sceneEl.camera);
        
        console.log(`WebGL Canvas —Ä–∞–∑–º–µ—Ä—ã: ${webglCanvas.width}x${webglCanvas.height}`);
        
        // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º AR —Ä–µ–Ω–¥–µ—Ä –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ —Å —Ç–æ—á–Ω—ã–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(
            webglCanvas,
            0, 0, webglCanvas.width, webglCanvas.height,    // –≤–µ—Å—å WebGL canvas
            0, 0, viewportWidth, viewportHeight             // —Ç–æ—á–Ω–æ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º viewport
        );
        
        const dataURL = compositeCanvas.toDataURL('image/png', 1.0);
        currentPhotoData = dataURL;
        
        console.log(`–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ: ${viewportWidth}x${viewportHeight}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
        const preview = document.getElementById('photoPreview');
        const controls = document.getElementById('previewControls');
        
        preview.src = dataURL;
        preview.style.display = 'block';
        controls.style.display = 'flex';
        
        updateStatus('–ö–æ–º–ø–æ–∑–∏—Ç–Ω–æ–µ —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ!');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ —Ñ–æ—Ç–æ:', error);
        throw error;
    }
}

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –º–µ—Ç–æ–¥ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)
async function takePhotoAlternative() {
    try {
        updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ AR —Ñ–æ—Ç–æ (–º–µ—Ç–æ–¥ 2)...');
        
        // –°–∫—Ä—ã–≤–∞–µ–º UI
        const uiElements = document.querySelector('.ui-elements');
        uiElements.classList.add('hidden');
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // –í—Å–ø—ã—à–∫–∞
        const flash = document.getElementById('photoFlash');
        flash.style.opacity = '0.7';
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –º–µ—Ç–æ–¥
        await takeCompositePhoto();
        
        // –£–±–∏—Ä–∞–µ–º –≤—Å–ø—ã—à–∫—É
        setTimeout(() => {
            flash.style.opacity = '0';
        }, 100);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ AR —Ñ–æ—Ç–æ:', error);
        updateStatus('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ AR —Ñ–æ—Ç–æ: ' + error.message);
        
        const uiElements = document.querySelector('.ui-elements');
        uiElements.classList.remove('hidden');
        
        const flash = document.getElementById('photoFlash');
        flash.style.opacity = '0';
    }
}

function savePhoto() {
    if (!currentPhotoData) return;
    
    try {
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const link = document.createElement('a');
        link.download = `ar-photo-${new Date().getTime()}.png`;
        link.href = currentPhotoData;
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –∫–ª–∏–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        updateStatus('–§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        closePreview();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        updateStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–≤—å—é
function closePreview() {
    const preview = document.getElementById('photoPreview');
    const controls = document.getElementById('previewControls');
    const uiElements = document.querySelector('.ui-elements');
    
    preview.style.display = 'none';
    controls.style.display = 'none';
    uiElements.classList.remove('hidden');
    
    currentPhotoData = null;
    updateStatus('–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
function initializeMarkers() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä –ß–µ–±—É—Ä–∞—à–∫–∏
    if (typeof CheburashkaMarker !== 'undefined') {
        activeMarkers.cheburashka = new CheburashkaMarker(0);
        activeMarkers.cheburashka.init();
        console.log('–ú–∞—Ä–∫–µ—Ä –ß–µ–±—É—Ä–∞—à–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } else {
        console.error('–ú–æ–¥—É–ª—å CheburashkaMarker –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    }
    
    updateStatus('–ú–∞—Ä–∫–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR
document.addEventListener('DOMContentLoaded', () => {
    const sceneEl = document.querySelector('#ar-scene');
    
    sceneEl.addEventListener('renderstart', () => {
        updateStatus('AR –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ AR
        setTimeout(() => {
            initializeMarkers();
        }, 1000);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ AR
    sceneEl.addEventListener('error', (event) => {
        console.error('AR Error:', event);
        updateStatus('–û—à–∏–±–∫–∞ AR');
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à (–ø—Ä–æ–±–µ–ª –¥–ª—è —Ñ–æ—Ç–æ)
document.addEventListener('keydown', (event) => {
    if (event.code === 'Space') {
        event.preventDefault();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –ø—Ä–µ–≤—å—é
        const preview = document.getElementById('photoPreview');
        if (preview.style.display === 'block') {
            closePreview();
        } else {
            takePhotoAlternative();
        }
    }
    
    if (event.code === 'Enter' && currentPhotoData) {
        event.preventDefault();
        savePhoto();
    }
    
    if (event.code === 'Escape') {
        event.preventDefault();
        closePreview();
    }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', (event) => {
    if (currentPhotoData) {
        event.preventDefault();
        event.returnValue = '';
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
function getMarkersStatus() {
    const status = {};
    Object.keys(activeMarkers).forEach(key => {
        if (activeMarkers[key] && typeof activeMarkers[key].getStatus === 'function') {
            status[key] = activeMarkers[key].getStatus();
        }
    });
    console.log('–°—Ç–∞—Ç—É—Å –º–∞—Ä–∫–µ—Ä–æ–≤:', status);
    return status;
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.activeMarkers = activeMarkers;
window.getMarkersStatus = getMarkersStatus;
</script>
</body>
</html>